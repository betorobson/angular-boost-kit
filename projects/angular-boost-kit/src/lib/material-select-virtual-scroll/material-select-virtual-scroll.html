<ng-template #defaultTemplate let-itemSelected="itemSelected">
  @if(config.multiple && itemSelected.length){
    @for(item of itemSelected; track $index){
      {{item.data?.[config.optionItemDescription]}},
    }
  }@else if(itemSelected){
    {{itemSelected.data?.[config.optionItemDescription]}}
  }
</ng-template>

@if(loading){
  <div class="loading-overlay">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
}

<mat-form-field
  [ngClass]="{
    'has-value': hasValue,
    'replace-arrow-by-reset-button': config.replaceArrowByResetButton
  }
  "
>
  <mat-label>Items</mat-label>
  <mat-select
    (openedChange)="openedChange()"
    (opened)="opened()"
    [formControl]="config.formControl"
    [multiple]="config.multiple"
  >
    <mat-select-trigger>
      <ng-container
        [ngTemplateOutlet]="triggerTemplate || optionTemplate || defaultTemplate"
        [ngTemplateOutletContext]="{
          itemSelected: config.multiple
            ? itemSelected
            : itemSelected?.[0]
         }"
      ></ng-container>
    </mat-select-trigger>
    @if(!loading){
      <div class="container-panel">
        <mat-form-field
          class="field-search"
        >
          <mat-label>Busca</mat-label>
          <input #inputSearch type="text" matInput [formControl]="formControlSearch" />
        </mat-form-field>
        <cdk-virtual-scroll-viewport
          [itemSize]="48"
          [minBufferPx]="400"
          [maxBufferPx]="400"
          class="virtual-scroll-viewport"
        >
          @if(
            !config.hideResetOption
            &&
            !config.replaceArrowByResetButton
          ){
            <mat-option
              [value]="null"
              (click)="itemSelect(null)"
            >None</mat-option>
          }
          <mat-option
            *cdkVirtualFor="
              let optionItem of options;
              templateCacheSize: 0;
            "
            [value]="getItemValue(optionItem)"
            (click)="optionSelect(optionItem)"
          >
            <ng-container
              [ngTemplateOutlet]="optionTemplate || defaultTemplate"
              [ngTemplateOutletContext]="{ itemSelected: optionItem }"
            ></ng-container>
          </mat-option>
        </cdk-virtual-scroll-viewport>
      </div>
    }
    @if (hasValue) {
      <mat-option
        [value]="getItemValue(itemSelected[0])"
        class="option-workaround"
      >
      </mat-option>
    }
  </mat-select>
  @if (
    hasValue
    &&
    config.replaceArrowByResetButton
  ) {
    <button
      (click)="reset($event)"
      type="button" mat-icon-button matSuffix
    >
      <mat-icon>cancel</mat-icon>
    </button>
  }
</mat-form-field>
